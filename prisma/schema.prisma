generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Enums
enum BugStatus {
  open
  in_progress
  resolved
  closed
  rejected
}

enum BugPriority {
  low
  medium
  high
  critical
}

enum BugSeverity {
  minor
  major
  critical
}

enum UserRole {
  admin
  developer
  tester
}

model User {
  id          String @id @default(uuid())
  username    String   @unique @db.VarChar(50)
  displayName String   @db.VarChar(100)
  password    String   @db.VarChar(255)
  roles       UserRole @default(tester)
  
  // Relations
  createdBugs  Bug[]        @relation("BugCreator")
  assignedBugs Bug[]        @relation("BugAssignee")
  bugComments  BugComment[]
  bugHistories BugHistory[]
}

model Bug {
  id          String @id @default(uuid())
  title       String      @db.VarChar(200)
  description String      @db.Text
  status      BugStatus   @default(open)
  priority    BugPriority @default(medium)
  severity    BugSeverity @default(minor)
  
  // Foreign keys
  creatorId  String   
  assigneeId String?  
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  creator   User         @relation("BugCreator", fields: [creatorId], references: [id])
  assignee  User?        @relation("BugAssignee", fields: [assigneeId], references: [id])
  comments  BugComment[]
  histories BugHistory[]
  
  @@index([status])
  @@index([priority])
  @@index([creatorId])
  @@index([assigneeId])
  @@index([createdAt])
}

model BugComment {
  id        String @id @default(uuid())
  content   String   @db.Text
  bugId     String   
  userId    String   
  createdAt DateTime @default(now())
  
  bug  Bug  @relation(fields: [bugId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id])
  
  @@index([bugId])
  @@index([createdAt])
}

enum BugAction {
  created
  assigned
  status_changed
  commented
}

model BugHistory {
  id        String @id @default(uuid())
  bugId     String   
  userId    String   
  action    BugAction
  oldValue  String?  @db.Text
  newValue  String?  @db.Text
  createdAt DateTime @default(now())

  bug  Bug  @relation(fields: [bugId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id])

  @@index([bugId])
  @@index([createdAt])
}